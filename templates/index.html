<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload for eBay - King Cyrus Cards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 24px;
            font-size: 24px;
        }
        .upload-section {
            margin-bottom: 24px;
        }
        .camera-btn {
            width: 100%;
            padding: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 12px;
        }
        .camera-btn:active {
            background: #0056b3;
        }
        input[type="file"] {
            display: none;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 24px;
        }
        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .count {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }
        .ebay-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #eee;
        }
        .listing-btn {
            width: 100%;
            padding: 12px;
            background: #0064d2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
        }
        .listing-btn:hover {
            background: #0052a3;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 24px;
            max-width: 500px;
            border-radius: 12px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-configured {
            background: #d4edda;
            color: #155724;
        }
        .status-not-configured {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∏ Upload Images for eBay - King Cyrus Cards</h1>
        
        <a href="/settings" style="display: block; text-align: center; color: #0064d2; text-decoration: none; font-size: 14px; margin-bottom: 16px;">‚öôÔ∏è Settings (open on computer)</a>
        
        <div class="status" id="status"></div>
        
        <div class="count" id="imageCount">0 images uploaded</div>
        
        <div class="upload-section">
            <input type="file" id="fileInput" accept="image/*" capture="environment" multiple>
            <button class="camera-btn" onclick="document.getElementById('fileInput').click()">
                üì∑ Take/Upload Photos
            </button>
        </div>
        
        <div class="image-grid" id="imageGrid"></div>
        
        <div class="ebay-section">
            <h2>üè∑Ô∏è eBay Listing</h2>
            <div id="ebayStatus"></div>
            <button class="listing-btn" onclick="openListingModal()">üì¶ Create eBay Listing</button>
        </div>
    </div>

    <!-- Create Listing Modal -->
    <div id="listingModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeListingModal()">&times;</span>
            <h2>Create eBay Listing</h2>
            
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="listingTitle" placeholder="Item title" maxlength="80">
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="listingDescription" placeholder="Item description"></textarea>
            </div>
            
            <div class="form-group">
                <label>Price (USD) *</label>
                <input type="number" id="listingPrice" placeholder="9.99" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label>Quantity *</label>
                <input type="number" id="listingQuantity" value="1" min="1">
            </div>
            
            <div class="form-group">
                <label>Category ID *</label>
                <input type="text" id="categoryId" placeholder="e.g., 261328 for Sports Trading Cards">
                <p class="info-text">Find category IDs in <a href="https://pages.ebay.com/sellerinformation/growing/categorychanges.html" target="_blank">eBay Category List</a></p>
            </div>
            
            <div class="form-group">
                <label>Condition</label>
                <select id="condition">
                    <option value="NEW">New</option>
                    <option value="LIKE_NEW">Like New</option>
                    <option value="USED_EXCELLENT">Used - Excellent</option>
                    <option value="USED_GOOD">Used - Good</option>
                    <option value="USED_ACCEPTABLE">Used - Acceptable</option>
                </select>
            </div>
            
            <p class="info-text">Images: All uploaded images will be included</p>
            
            <button class="listing-btn" onclick="createListing()">üöÄ Create Listing</button>
        </div>
    </div>

    <script>
        let uploadedImages = [];

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        function updateImageCount() {
            document.getElementById('imageCount').textContent = 
                uploadedImages.length + ' image' + (uploadedImages.length !== 1 ? 's' : '') + ' uploaded';
        }

        function renderImages() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = uploadedImages.map((img, index) => `
                <div class="image-item">
                    <img src="/uploads/${img}" alt="Uploaded image ${index + 1}">
                    <button class="delete-btn" onclick="deleteImage('${img}', ${index})">√ó</button>
                </div>
            `).join('');
        }

        async function deleteImage(filename, index) {
            if (!confirm('Delete this image?')) return;
            
            try {
                const response = await fetch('/delete/' + filename, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    uploadedImages.splice(index, 1);
                    renderImages();
                    updateImageCount();
                    showStatus('Image deleted', 'success');
                } else {
                    showStatus('Failed to delete image', 'error');
                }
            } catch (error) {
                showStatus('Error deleting image', 'error');
            }
        }

        async function loadExistingImages() {
            try {
                const response = await fetch('/images');
                const data = await response.json();
                uploadedImages = data.images;
                renderImages();
                updateImageCount();
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        uploadedImages.push(data.filename);
                        showStatus('Image uploaded successfully', 'success');
                    } else {
                        showStatus('Upload failed: ' + data.error, 'error');
                    }
                } catch (error) {
                    showStatus('Upload error: ' + error.message, 'error');
                }
            }

            renderImages();
            updateImageCount();
            e.target.value = ''; // Reset input
        });

        // Load existing images on page load
        loadExistingImages();
        
        // Check eBay configuration status
        checkEbayStatus();
        
        // eBay Functions
        async function checkEbayStatus() {
            try {
                const response = await fetch('/ebay/config');
                const data = await response.json();
                
                const statusDiv = document.getElementById('ebayStatus');
                if (data.configured) {
                    statusDiv.innerHTML = '<span class="status-badge status-configured">‚úì eBay Configured</span>';
                } else {
                    statusDiv.innerHTML = '<span class="status-badge status-not-configured">‚úó Configure eBay in <a href="/settings">Settings</a></span>';
                }
            } catch (error) {
                console.error('Error checking eBay status:', error);
            }
        }
        
        async function loadDefaults() {
            try {
                const response = await fetch('/settings/defaults');
                const data = await response.json();
                
                // Pre-fill form with defaults
                if (data.category_id) document.getElementById('categoryId').value = data.category_id;
                if (data.condition) document.getElementById('condition').value = data.condition;
                if (data.quantity) document.getElementById('listingQuantity').value = data.quantity;
            } catch (error) {
                console.error('Error loading defaults:', error);
            }
        }
        
        function openListingModal() {
            if (uploadedImages.length === 0) {
                alert('Please upload at least one image first!');
                return;
            }
            loadDefaults();
            document.getElementById('listingModal').style.display = 'block';
        }
        
        function closeListingModal() {
            document.getElementById('listingModal').style.display = 'none';
        }
        
        async function createListing() {
            const listing = {
                title: document.getElementById('listingTitle').value,
                description: document.getElementById('listingDescription').value,
                price: document.getElementById('listingPrice').value,
                quantity: document.getElementById('listingQuantity').value,
                category_id: document.getElementById('categoryId').value,
                condition: document.getElementById('condition').value,
                images: uploadedImages
            };
            
            if (!listing.title || !listing.description || !listing.price || !listing.category_id) {
                alert('Please fill in all required fields (*)');
                return;
            }
            
            try {
                showStatus('Creating listing...', 'success');
                
                const response = await fetch('/ebay/create-listing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(listing)
                });
                
                const data = await response.json();
                if (data.success) {
                    showStatus('Listing created successfully!', 'success');
                    closeListingModal();
                    // Clear form
                    document.getElementById('listingTitle').value = '';
                    document.getElementById('listingDescription').value = '';
                    document.getElementById('listingPrice').value = '';
                    document.getElementById('categoryId').value = '';
                } else {
                    showStatus('Failed to create listing: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('Error creating listing: ' + error.message, 'error');
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>